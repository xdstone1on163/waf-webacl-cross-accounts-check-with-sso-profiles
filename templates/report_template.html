<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Security Configuration Audit Report</title>
    <style>
        {{ styles_css | safe }}
    </style>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
</head>
<body>
    <header>
        <h1>AWS Security Configuration Audit Report</h1>
        <p>Generated: {{ timestamp }}</p>
    </header>

    <nav>
        <a href="#summary">Summary</a>
        <a href="#network-graph">Network Graph</a>
        <a href="#tree-diagram">Tree Diagram</a>
        <a href="#dashboard">Dashboard</a>
        <a href="#vulnerabilities">Vulnerabilities</a>
    </nav>

    <!-- æ‘˜è¦éƒ¨åˆ† -->
    <section id="summary">
        <h2>ğŸ“Š Summary</h2>
        <div id="summary-cards" class="summary-cards"></div>

        {% if warnings and warnings|length > 0 %}
        <div class="warning-box">
            <h3>âš ï¸ Warnings ({{ warnings|length }})</h3>
            <ul>
                {% for warning in warnings[:10] %}
                <li>{{ warning.message }}</li>
                {% endfor %}
                {% if warnings|length > 10 %}
                <li><em>...and {{ warnings|length - 10 }} more</em></li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
    </section>

    <!-- ç½‘ç»œå›¾éƒ¨åˆ† -->
    <section id="network-graph">
        <h2>1. Relationship Network Graph</h2>
        <p>Interactive visualization of DNS â†’ ALB â†’ WAF relationships. Drag nodes to explore, click for details.</p>
        <div id="network-graph-container"></div>
    </section>

    <!-- æ ‘çŠ¶å›¾éƒ¨åˆ† -->
    <section id="tree-diagram">
        <h2>2. Hierarchical Tree Diagram</h2>
        <p>Organizational view of resources by Account â†’ Region â†’ Type.</p>
        <div id="tree-diagram-container"></div>
    </section>

    <!-- ç»Ÿè®¡ä»ªè¡¨ç›˜éƒ¨åˆ† -->
    <section id="dashboard">
        <h2>3. Statistics Dashboard</h2>
        <div id="dashboard-container">
            <div class="chart-card">
                <canvas id="waf-coverage-chart"></canvas>
            </div>
            <div class="chart-card">
                <canvas id="by-account-chart"></canvas>
            </div>
            <div class="chart-card">
                <canvas id="by-region-chart"></canvas>
            </div>
        </div>
    </section>

    <!-- å®‰å…¨æ¼æ´åˆ—è¡¨éƒ¨åˆ† -->
    <section id="vulnerabilities">
        <h2>4. Security Vulnerabilities</h2>
        <p>Identified security issues that require attention.</p>
        <table id="vulnerabilities-table" class="display" style="width:100%"></table>
    </section>

    <!-- é¡µè„š -->
    <footer style="text-align: center; padding: 2rem; color: #666; font-size: 0.9rem;">
        <p>Generated by AWS Security Audit Tool</p>
        <p>ğŸ¤– Powered by Claude Code</p>
    </footer>

    <!-- JavaScript åº“ (CDN) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- åµŒå…¥æ•°æ® -->
    <script>
        const networkGraphData = {{ network_graph_data | tojson }};
        const treeData = {{ tree_data | tojson }};
        const dashboardData = {{ dashboard_data | tojson }};
        const vulnerabilitiesData = {{ vulnerabilities_data | tojson }};
    </script>

    <!-- ç½‘ç»œå›¾è„šæœ¬ -->
    <script>
        {{ network_graph_js | safe }}
    </script>

    <!-- æ ‘çŠ¶å›¾è„šæœ¬ -->
    <script>
        {{ tree_diagram_js | safe }}
    </script>

    <!-- ä»ªè¡¨ç›˜è„šæœ¬ -->
    <script>
        {{ dashboard_charts_js | safe }}
    </script>

    <!-- æ¼æ´åˆ—è¡¨è„šæœ¬ -->
    <script>
        $(document).ready(function() {
            if (vulnerabilitiesData && vulnerabilitiesData.length > 0) {
                $('#vulnerabilities-table').DataTable({
                    data: vulnerabilitiesData,
                    columns: [
                        {
                            title: "Severity",
                            data: "severity",
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    return '<span class="severity-badge severity-' + data + '">' + data + '</span>';
                                }
                                return data;
                            }
                        },
                        { title: "Type", data: "type" },
                        { title: "Resource", data: "resource" },
                        { title: "Description", data: "description" },
                        { title: "Account", data: "account_id" },
                        { title: "Region", data: "region" }
                    ],
                    order: [[0, 'desc']],  // æŒ‰ä¸¥é‡çº§åˆ«æ’åº
                    pageLength: 25,
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel'
                    ]
                });
            } else {
                $('#vulnerabilities-table').html('<p style="padding: 2rem; text-align: center; color: #4CAF50;">âœ“ No vulnerabilities detected</p>');
            }
        });
    </script>

    <!-- å¹³æ»‘æ»šåŠ¨ -->
    <script>
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>

    <!-- åˆå§‹åŒ–æ‰€æœ‰å¯è§†åŒ– -->
    <script>
        // ç­‰å¾… DOM å®Œå…¨åŠ è½½åæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸²æŸ“ç½‘ç»œå›¾
            if (typeof renderNetworkGraph === 'function' && typeof networkGraphData !== 'undefined' && networkGraphData) {
                renderNetworkGraph(networkGraphData);
            } else {
                console.error("Network graph: function or data not available");
            }

            // æ¸²æŸ“æ ‘çŠ¶å›¾
            if (typeof renderTreeDiagram === 'function' && typeof treeData !== 'undefined' && treeData) {
                renderTreeDiagram(treeData);
            } else {
                console.error("Tree diagram: function or data not available");
            }

            // æ¸²æŸ“ä»ªè¡¨ç›˜
            if (typeof renderDashboard === 'function' && typeof dashboardData !== 'undefined' && dashboardData) {
                renderDashboard(dashboardData);
            } else {
                console.error("Dashboard: function or data not available");
            }
        });
    </script>
</body>
</html>
